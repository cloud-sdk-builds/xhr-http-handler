var e,t,r,n,o,s,i,a,u={7(e){var t,r="object"==typeof Reflect?Reflect:null,n=r&&"function"==typeof r.apply?r.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};t=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise(function(r,n){function o(r){e.removeListener(t,s),n(r)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",o),r([].slice.call(arguments))}v(e,t,s,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&v(e,"error",t,{once:!0})}(e,o)})},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var i=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function c(e,t,r,n){var o,s,i,c;if(a(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),i=s[t]),void 0===i)i=s[t]=r,++e._eventsCount;else if("function"==typeof i?i=s[t]=n?[r,i]:[i,r]:n?i.unshift(r):i.push(r),(o=u(e))>0&&i.length>o&&!i.warned){i.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=e,f.type=t,f.count=i.length,c=f,console&&console.warn&&console.warn(c)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},o=f.bind(n);return o.listener=r,n.wrapFn=o,o}function h(e,t,r){var n=e._events;if(void 0===n)return[];var o=n[t];return void 0===o?[]:"function"==typeof o?r?[o.listener||o]:[o]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(o):d(o,o.length)}function l(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function d(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function v(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function o(s){n.once&&e.removeEventListener(t,o),r(s)})}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return i},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");i=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var o="error"===e,s=this._events;if(void 0!==s)o=o&&void 0===s.error;else if(!o)return!1;if(o){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var u=s[e];if(void 0===u)return!1;if("function"==typeof u)n(u,this,t);else{var c=u.length,f=d(u,c);for(r=0;r<c;++r)n(f[r],this,t)}return!0},s.prototype.addListener=function(e,t){return c(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return c(this,e,t,!0)},s.prototype.once=function(e,t){return a(t),this.on(e,p(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,p(this,e,t)),this},s.prototype.removeListener=function(e,t){var r,n,o,s,i;if(a(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(o=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){i=r[s].listener,o=s;break}if(o<0)return this;0===o?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,o),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,i||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var o,s=Object.keys(r);for(n=0;n<s.length;++n)"removeListener"!==(o=s[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},s.prototype.listeners=function(e){return h(this,e,!0)},s.prototype.rawListeners=function(e){return h(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):l.call(e,t)},s.prototype.listenerCount=l,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}}},c={};function f(e){var t=c[e];if(void 0!==t)return t.exports;var r=c[e]={exports:{}};return u[e](r,r.exports,f),r.exports}f.d=(e,t)=>{for(var r in t)f.o(t,r)&&!f.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},f.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),function(e){e.HEADER="header",e.QUERY="query"}(e||(e={})),function(e){e.HEADER="header",e.QUERY="query"}(t||(t={})),function(e){e.HTTP="http",e.HTTPS="https"}(r||(r={})),function(e){e.MD5="md5",e.CRC32="crc32",e.CRC32C="crc32c",e.SHA1="sha1",e.SHA256="sha256"}(n||(n={})),(a=o||(o={}))[a.HEADER=0]="HEADER",a[a.TRAILER=1]="TRAILER",function(e){e.PROFILE="profile",e.SSO_SESSION="sso-session",e.SERVICES="services"}(s||(s={})),function(e){e.HTTP_0_9="http/0.9",e.HTTP_1_0="http/1.0",e.TDS_8_0="tds/8.0"}(i||(i={}));class p{constructor(e){this.statusCode=e.statusCode,this.reason=e.reason,this.headers=e.headers||{},this.body=e.body}static isInstance(e){if(!e)return!1;const t=e;return"number"==typeof t.statusCode&&"object"==typeof t.headers}}const h=e=>encodeURIComponent(e).replace(/[!'()*]/g,l),l=e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`;var d=f(7);const v=(e=0)=>new Promise((t,r)=>{e&&setTimeout(()=>{const t=new Error(`Request did not complete within ${e} ms`);t.name="TimeoutError",r(t)},e)}),y={get PROGRESS(){return"xhr.progress"},get UPLOAD_PROGRESS(){return"xhr.upload.progress"},get XHR_INSTANTIATED(){return"after.xhr.new"},get BEFORE_XHR_SEND(){return"before.xhr.send"}};class m extends d.EventEmitter{constructor(e){super(),"function"==typeof e?this.configProvider=e():(this.config=e??{},this.configProvider=Promise.resolve(this.config))}updateHttpClientConfig(e,t){this.config=void 0,this.configProvider=this.configProvider.then(r=>(r[e]=t,r))}httpHandlerConfigs(){return this.config??{}}destroy(){}async handle(e,{abortSignal:t}={}){this.config||(this.config=await this.configProvider);const r=0|Number(this.config.requestTimeout);if(t?.aborted){const e=new Error("Request aborted");throw e.name="AbortError",e}let n=e.path;if(e.query){const t=function(e){const t=[];for(let r of Object.keys(e).sort()){const n=e[r];if(r=h(r),Array.isArray(n))for(let e=0,o=n.length;e<o;e++)t.push(`${r}=${h(n[e])}`);else{let e=r;(n||"string"==typeof n)&&(e+=`=${h(n)}`),t.push(e)}}return t.join("&")}(e.query);t&&(n+=`?${t}`)}const{port:o,method:s}=e,i=`${e.protocol}//${e.hostname}${o?`:${o}`:""}${n}`,a="GET"===s||"HEAD"===s?void 0:e.body,u=new XMLHttpRequest;this.emit(y.XHR_INSTANTIATED,u);const c=[new Promise((t,r)=>{let n,o,c=0;u.upload.addEventListener("progress",t=>{this.emit(m.EVENTS.UPLOAD_PROGRESS,t,e)}),u.addEventListener("progress",t=>{this.emit(m.EVENTS.PROGRESS,t,e)}),u.addEventListener("error",e=>{const t=new Error(m.ERROR_IDENTIFIER+": "+e);r(t)}),u.addEventListener("timeout",()=>{r(new Error("XMLHttpRequest timed out."))}),u.addEventListener("readystatechange",()=>{const e="arraybuffer"===u.responseType&&u.response,s=!e&&"string"==typeof u.responseText;switch(s&&!n&&({stream:n,writer:o}=this.initializeTransformStream()),u.readyState){case XMLHttpRequest.LOADING:s&&(o.write(c>0?u.responseText.slice(c):u.responseText),c=u.responseText.length);break;case XMLHttpRequest.DONE:const i=e?new Blob([u.response]):s?(c!==u.responseText.length&&o.write?.(c>0?u.responseText.slice(c):u.responseText),o.releaseLock(),n.writable.close(),n.readable):void r(new Error(`Unexpected XHR response type ${u.responseType}. Expected string or arraybuffer.`));t({response:new p({headers:this.responseHeaders(u.getAllResponseHeaders()),statusCode:u.status,body:i})})}}),u.open(s,i);for(const[t,r]of Object.entries(e.headers))E(t)||u.setRequestHeader(t,r);this.emit(y.BEFORE_XHR_SEND,u),u.send(a)}),v(r)];return t&&c.push(new Promise((e,r)=>{t.onabort=()=>{u.abort();const e=new Error("Request aborted");e.name="AbortError",r(e)}})),Promise.race(c)}responseHeaders(e){return e?e.split("\r\n").reduce((e,t)=>{const r=t.split(": "),n=r.shift(),o=r.join(": ");return e[n]=o,e},{}):{}}initializeTransformStream(){const e=new TextEncoder,t=new TransformStream({start(){},async transform(t,r){r.enqueue(e.encode(String(t)))},flush(){}}),r=t.writable.getWriter();return{stream:t,writer:r}}}m.EVENTS=y,m.ERROR_IDENTIFIER="XHR_HTTP_HANDLER_ERROR";const E=e=>!!(e=e.toLowerCase()).startsWith("proxy-")||!!e.startsWith("sec-")||g.includes(e),g=["Accept-Charset","Accept-Encoding","Access-Control-Request-Headers","Access-Control-Request-Method","Connection","Content-Length","Cookie","Date","DNT","Expect","Feature-Policy","Host","Keep-Alive","Origin","Referer","TE","Trailer","Transfer-Encoding","Upgrade","Via"].map(e=>e.toLowerCase());export{m as XhrHttpHandler};